# -- MySQL --

CREATE TABLE KHACH_HANG(
    MAKH INT PRIMARY KEY, 
    TENKH VARCHAR(30),
    DIACHI VARCHAR(50),
    SDT CHAR(11)
); 

CREATE TABLE PHONG(
    MAPHONG INT PRIMARY KEY,
    LOAIPHONG VARCHAR(20),
    SOKHACHTOIDA INT,
    GIAPHONG DECIMAL(6,3),
    MOTA VARCHAR(255)
);

CREATE TABLE DAT_PHONG(
    MADATPHONG INT PRIMARY KEY,
    MAPHONG INT,
    MAKH INT,
    NGAYDAT DATE,
    GIOBATDAU TIME,
    GIOKETTHUC TIME,
    TIENDATCOC DECIMAL(6,3),
    GHICHU VARCHAR(255),
    TRANGTHAIDAT VARCHAR(30),
    FOREIGN KEY (MAPHONG) REFERENCES PHONG(MAPHONG),
    FOREIGN KEY (MAKH) REFERENCES khach_hang(MAKH)
);

CREATE TABLE DICH_VU_DI_KEM(
    MADV INT PRIMARY KEY,
    TENDV VARCHAR(255),
    DONVITINH VARCHAR(30),
    DONGIA DECIMAL(6,3)
);

CREATE TABLE CHI_TIET_SU_DUNG_DV(
    MADATPHONG INT,
    MADV INT,
    SOLUONG INT,
    PRIMARY KEY (MADATPHONG, MADV),
    FOREIGN KEY (MADATPHONG) REFERENCES dat_phong(MADATPHONG)
);

-- INSERT DATA 
 
INSERT INTO phong (MAPHONG, LOAIPHONG, SOKHACHTOIDA, GIAPHONG, MOTA) VALUES
(1, 'LOAI 1', 150, '50.000', ''),
(2, 'LOAI 1', 25, '65.000', ''),
(3, 'LOAI 2', 15, '70.000', ''),
(4, 'LOAI 2', 9, '60.000', ''),
(5, 'LOAI 3', 20, '100.000', '');
 
INSERT INTO khach_hang (MAKH, TENKH, DIACHI, SDT) VALUES
(1, 'MARIA OZAWA', 'HOA XUAN', '11111111111'),
(2, 'TOKUDA', 'HOA XUAN', '11111111112'),
(3, 'MIKAMI YUA', 'HOA XUAN', '11111111113'),
(4, 'MARIA OZAWA', 'HOA XUAN', '11111111111'),
(5, 'NGUYEN VAN D', 'HOA XUAN', '11111111114');
 
INSERT INTO dich_vu_di_kem (MADV, TENDV, DONVITINH, DONGIA) VALUES
(1, 'HOT GIRL', 'EM', '10.000'),
(2, 'HOA HAU', 'EM', '20.000'),
(3, 'BEER', 'LON', '10.000'),
(4, 'TRAI CAY', 'DIA', '35.000'),
(5, 'MICRO', 'CAI', '3.000');
 
 
INSERT INTO dat_phong (MADATPHONG, MAPHONG, MAKH, NGAYDAT, GIOBATDAU, GIOKETTHUC, TIENDATCOC, GHICHU, TRANGTHAIDAT) VALUES
(1, 1, 2, '2016-03-26', '11:00:00', '13:00:00', '100.000', '', 'DA DAT'),
(2, 1, 3, '2017-03-27', '17:15:00', '19:15:00', '50.000', '', 'DA HUY'),
(3, 2, 2, '2015-03-26', '20:30:00', '22:15:00', '100.000', '', 'DA DAT'),
(4, 3, 1, '2017-04-01', '19:30:00', '21:15:00', '200.000', '', 'DA DAT'),
(5, 5, 5, '2017-09-26', '20:30:00', '22:15:00', '100.000', '', 'DA DAT');
 
INSERT INTO chi_tiet_su_dung_dv (MADATPHONG, MADV, SOLUONG) VALUES
(1, 1, 20),
(1, 2, 10),
(1, 3, 3),
(2, 2, 10),
(2, 3, 1),
(3, 2, 2),
(3, 3, 5),
(3, 4, 10),
(4, 1, 6),
(4, 5, 4),
(4, 3, 7);


-- BAI LAM
-- PHAN 1.1
SELECT MADATPHONG, MADV, SOLUONG 
  FROM CHI_TIET_SU_DUNG_DV
  WHERE SOLUONG > 3 AND SOLUONG < 10;

-- PHAN 1.2
UPDATE PHONG 
  SET GIAPHONG = GIAPHONG + '10.000' 
  WHERE SOKHACHTOIDA > 10;
SELECT * FROM PHONG;

-- PHAN 1.3
  -- XOA TRONG BANG CHI_TIET_SU_DUNG_DV VI PRIMARY KEY MADATPHONG
DELETE CTDV
  FROM CHI_TIET_SU_DUNG_DV CTDV
  JOIN DAT_PHONG DP ON CTDV.MADATPHONG = DP.MADATPHONG
  WHERE DP.TRANGTHAIDAT = 'DA HUY';
DELETE FROM DAT_PHONG
  WHERE TRANGTHAIDAT = 'DA HUY';
SELECT * FROM DAT_PHONG;

-- PHAN 2.4
SELECT TENKH 
  FROM KHACH_HANG
  WHERE TENKH LIKE 'H%' OR TENKH LIKE 'NM%'; -- YEU CAU DE: TENKH BAT DAU 'H', 'NM'

-- PHAN 2.5
SELECT DISTINCT TENKH  -- CACH 1
  FROM KHACH_HANG;
SELECT TENKH  -- CACH 2
  FROM KHACH_HANG
  GROUP BY TENKH;

-- PHAN 2.6
SELECT MADV, TENDV, DONVITINH, DONGIA 
  FROM DICH_VU_DI_KEM
  WHERE (DONVITINH = 'LON' AND DONGIA > '10.000') OR
    (DONVITINH = 'CAI' AND DONGIA < '5.000');

-- PHAN 2.7
SELECT 
  DP.MADATPHONG, 
  P.MAPHONG, 
  P.LOAIPHONG, 
  P.SOKHACHTOIDA, 
  P.GIAPHONG, 
  KH.MAKH, 
  KH.TENKH, 
  KH.SDT, 
  DP.NGAYDAT, 
  DP.GIOBATDAU, 
  DP.GIOKETTHUC, 
  CTDV.MADV, 
  CTDV.SOLUONG, 
  DVDK.DONGIA
  FROM DAT_PHONG DP
  JOIN PHONG P ON P.MAPHONG = DP.MAPHONG
  JOIN KHACH_HANG KH ON KH.MAKH = DP.MAKH
  JOIN CHI_TIET_SU_DUNG_DV CTDV ON CTDV.MADATPHONG = DP.MADATPHONG
  JOIN DICH_VU_DI_KEM DVDK ON CTDV.MADV = DVDK.MADV
  WHERE DP.NGAYDAT BETWEEN '2016-01-01' AND '2017-12-31'
  HAVING P.GIAPHONG > '50.000';

-- PHAN 3.8
SELECT 
  DP.MADATPHONG, 
  P.MAPHONG,
  P.LOAIPHONG,
  P.GIAPHONG,
  KH.TENKH,
  DP.NGAYDAT,
  CONVERT((TIMESTAMPDIFF(MINUTE, DP.GIOBATDAU, DP.GIOKETTHUC) / 60) * P.GIAPHONG, DECIMAL(10,3)) AS TONGTIENHAT,
  IFNULL(SUM(CTDV.SOLUONG * DVDK.DONGIA),0) AS TONGTIENSUDUNGDICVU,
  CONVERT((TIMESTAMPDIFF(MINUTE, DP.GIOBATDAU, DP.GIOKETTHUC) / 60) * P.GIAPHONG, DECIMAL(10,3)) + IFNULL(SUM(CTDV.SOLUONG * DVDK.DONGIA),0) AS THONGTINTHANHTOAN
  FROM DAT_PHONG DP
  JOIN PHONG P ON P.MAPHONG = DP.MAPHONG
  JOIN KHACH_HANG KH ON KH.MAKH = DP.MAKH
  LEFT JOIN CHI_TIET_SU_DUNG_DV CTDV ON CTDV.MADATPHONG = DP.MADATPHONG
  LEFT JOIN DICH_VU_DI_KEM DVDK ON DVDK.MADV = CTDV.MADV
  GROUP BY DP.MADATPHONG;
  
  
